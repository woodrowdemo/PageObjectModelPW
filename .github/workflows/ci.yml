name: CI

permissions:
  contents: read
  pages: write
  id-token: write

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Setup Node.js (for Playwright)
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore --configuration Release

      - name: Verify resources directory
        run: |
          # Find the build output directory dynamically
          OUTPUT_DIR=$(find bin/Release -type d -name "net*" | head -n 1)
          if [ -z "$OUTPUT_DIR" ]; then
            echo "ERROR: Could not find build output directory"
            exit 1
          fi
          echo "Found output directory: $OUTPUT_DIR"
          
          if [ ! -d "$OUTPUT_DIR/resources" ]; then
            echo "ERROR: resources directory not found in build output at $OUTPUT_DIR/resources"
            exit 1
          fi
          if [ ! -f "$OUTPUT_DIR/resources/appsettings.json" ]; then
            echo "ERROR: appsettings.json not found in resources directory"
            exit 1
          fi
          echo "Resources directory and appsettings.json verified successfully"

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run tests
        run: dotnet test --no-build --configuration Release --logger "trx;LogFileName=test_results.trx"

      - name: Prepare Extent report for Pages
        if: always()
        run: |
          mkdir -p reports
          latest=$(ls -t reports/*.html 2>/dev/null | head -n1 || true)
          if [ -n "$latest" ]; then
            echo "Copying $latest to reports/index.html"
            cp "$latest" reports/index.html
          else
            echo "No extent HTML report found in reports/"
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: '**/TestResults/**/*.trx'

      - name: Upload Extent HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: extent-report
          path: |
            reports/*.html

      - name: Upload reports and screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reports-and-screenshots
          path: |
            reports/**
            screenshots/**

  deploy_pages:
    name: Deploy Extent report to GitHub Pages
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Upload pages artifact
        uses: actions/upload-pages-artifact@v1
        with:
          path: reports

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v1
